from pathlib import Path
import re, html as _html
from collections import defaultdict

# Load user's base HTML (uploaded) to avoid losing content
base_path = Path("/mnt/data/mindmap_fix_render_links_fold_tb.html")
base_html = base_path.read_text(encoding="utf-8", errors="ignore")

# Try to extract the embedded markdown from the first .markmap container.
# Previous pattern: <div class="markmap"...> ESCAPED_MD </div>
m = re.search(r'<div[^>]*class="markmap"[^>]*>(.*?)</div>', base_html, re.DOTALL | re.IGNORECASE)
if not m:
    # fallback: any div with class markmap
    m = re.search(r'<div[^>]*class=[\'"]markmap[\'"][^>]*>(.*?)</div>', base_html, re.DOTALL | re.IGNORECASE)

embedded = m.group(1).strip() if m else ""
# remove surrounding whitespace/newlines
embedded = embedded.strip()

# embedded markdown is HTML-escaped. Unescape it.
base_md = _html.unescape(embedded)

# If base_md looks empty or not markdown, use a minimal header as fallback
if len(base_md.strip()) < 20 or "# " not in base_md:
    base_md = """---
title: Mindmap
markmap:
  colorFreezeLevel: 2
  direction: TB
---

# Mindmap
"""

# Ensure FOI rows_data exists from earlier work in this kernel
try:
    rows_data  # type: ignore
except NameError:
    raise RuntimeError("rows_data saknas (FOI-listan). Jag kan inte bygga full FOI-flik utan den.")

SNI_FULL = {
    "B": "Utvinning av mineral",
    "C": "Tillverkning",
    "E": "Vattenförsörjning, avloppsrening, avfallshantering och sanering",
    "F": "Byggverksamhet",
    "G": "Handel; reparation av motorfordon och motorcyklar",
    "H": "Transport och magasinering",
    "I": "Hotell- och restaurangverksamhet",
    "J": "Informations- och kommunikationsverksamhet",
    "K": "Finans- och försäkringsverksamhet",
    "L": "Fastighetsverksamhet",
    "M": "Verksamhet inom juridik, ekonomi, vetenskap och teknik",
    "N": "Uthyrning, fastighetsservice, resetjänster och andra stödtjänster",
    "P": "Utbildning",
    "R": "Kultur, nöje och fritid",
}

def esc_md(s: str) -> str:
    return (s or "").replace("\n", " ").replace("`", "'").strip()

# Build FOI section (ALL, no truncation) in mindmap + full searchable FOI tab with anchors
grp = defaultdict(list)
for nr, co, seat, sni, other in rows_data:
    grp[sni].append((nr, co, seat, other))

foi_lines = []
foi_lines.append("## FOI: Ryskt ägande i svenska företag (Tabell 2.1) – samtliga bolag (från din lista) <!-- markmap: fold -->")
foi_lines.append("- https://www.foi.se/rapportsammanfattning?reportNo=FOI-R--5377--SE")
foi_lines.append("")
for sni in sorted(grp.keys(), key=lambda x: (x not in SNI_FULL, x)):
    items = sorted(grp[sni], key=lambda x: x[0])
    sni_name = SNI_FULL.get(sni, f"SNI {sni}")
    foi_lines.append(f"### {sni_name} (SNI {sni}) – {len(items)} företag <!-- markmap: fold -->")
    for nr, co, seat, other in items:
        foi_lines.append(f"- [{esc_md(co)}](#c{nr}) <!-- markmap: fold -->")
        foi_lines.append(f"  - Nr: {nr}")
        foi_lines.append(f"  - Säte: {esc_md(seat)}")
        foi_lines.append(f"  - SNI: {sni} ({sni_name})")
        foi_lines.append(f"  - Övrigt (FOI-rad): {esc_md(other)}")
    foi_lines.append("")
foi_section_md = "\n".join(foi_lines)

mosk_section_md = """## Moskvapatriarkatet & FOI-listan (från din text) <!-- markmap: fold -->
### Moskvapatriarkatet (Rysk-ortodoxa kyrkan) <!-- markmap: fold -->
- Sverige: modern etablering från början av 1990-talet
- Församling: Helige Sergij av Radonezh (Stockholm, 1992)
- Medieuppgifter: plattform för påverkan/inhämtning
  - https://www.expressen.se/nyheter/sverige/efter-sapovarning-ryska-statskyrkan-utan-stod/
  - https://www.sverigesradio.se/artikel/efter-sapovarning-ryska-statskyrkan-utan-stod
- FOI: religion används i militära syften
  - https://www.foi.se/nyheter-och-press/nyheter/2024-06-05-sa-anvander-ryssland-religion-i-militara-syften.html

### Rosatom (statligt bolag) <!-- markmap: fold -->
- Uppgift: Rosatom kopplas till finansiering av Västeråskyrkan
  - https://www.svt.se/nyheter/lokalt/vastmanland/ryska-statens-karnkraftsbolag-ska-ha-betalat-for-kyrkobygget-i-vasteras
- Soft power via sociala fonder (enligt din text/källor)

### Västerås: kyrka nära flygplats/skyppsobjekt (case) <!-- markmap: fold -->
- Medier: byggkostnad ~35 MSEK (enligt din text)
- Placering: nära Västerås flygplats (skyddsobjekt) (enligt din text)

### Bolagsnoder kopplade till kyrkoflöden (som du nämner) <!-- markmap: fold -->
- [NC Nordic Control AB](#c49) (finns i FOI-listan)
  - Dagen (2021): grovt bokföringsbrott
    - https://www.dagen.se/nyheter/2021/04/10/rysk-ortodox-prast-domd-for-grovt-bokforingsbrott/
- [InstrumentElectronics i Stockholm AB](#c30) (finns i FOI-listan)
  - The Moscow Times (2023): GRU-misstankar i rapportering
    - https://www.themoscowtimes.com/2023/10/26/swedish-court-acquits-alleged-russian-agent-a82894
"""

# Combine: keep user's base mindmap markdown (unchanged) + append the new sections (so nothing is reduced)
combined_md = base_md.rstrip() + "\n\n" + mosk_section_md + "\n\n" + foi_section_md + "\n"

# Build FOI table with anchors for tab view
table_rows = "\n".join(
    f"<tr id='c{nr}'><td class='num'>{nr}</td><td>{_html.escape(co)}</td><td>{_html.escape(seat)}</td><td class='sni'>{_html.escape(sni)}</td><td>{_html.escape(other)}</td></tr>"
    for nr, co, seat, sni, other in sorted(rows_data, key=lambda x: x[0])
)

# Create final HTML with two tabs and link handling (external in new tab, internal #cNN -> FOI tab)
html_doc = f"""<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mindmap (ALLT) – Moskvapatriarkatet + FOI</title>
<style>
  html,body{{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}}
  header{{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.12);background:#fff}}
  button{{padding:8px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#f7f7f7;cursor:pointer}}
  button.active{{background:#111;color:#fff;border-color:#111}}
  .spacer{{flex:1}}
  .hint{{font-size:13px;color:rgba(0,0,0,.65)}}
  main{{height:calc(100vh - 56px)}}
  .tab{{display:none;height:100%}}
  .tab.active{{display:block}}
  .markmap{{width:100%;height:100%}}
  .markmap svg{{width:100%;height:100%}}
  .panel{{height:100%;display:flex;flex-direction:column;gap:10px;padding:12px;box-sizing:border-box}}
  .controls{{display:flex;gap:10px;flex-wrap:wrap;align-items:center}}
  .controls input{{flex:1;min-width:240px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.15)}}
  .meta{{font-size:13px;color:rgba(0,0,0,.65)}}
  .tablewrap{{flex:1;overflow:auto;border:1px solid rgba(0,0,0,.12);border-radius:14px}}
  table{{border-collapse:collapse;width:100%;font-size:13px}}
  th,td{{padding:7px 10px;border-bottom:1px solid rgba(0,0,0,.06);text-align:left;vertical-align:top}}
  th{{position:sticky;top:0;background:#fff;border-bottom:1px solid rgba(0,0,0,.12)}}
  tr:target{{outline:3px solid rgba(0,0,0,.35); outline-offset:-3px; background:rgba(0,0,0,.03)}}
  td.num{{width:60px;white-space:nowrap}}
  td.sni{{width:60px;white-space:nowrap}}
</style>
</head>
<body>

<header>
  <button id="btn-map" class="active">Mindmap</button>
  <button id="btn-foi">FOI-register</button>
  <div class="spacer"></div>
  <div class="hint">Klicka nod = fäll in/ut. Externa länkar öppnas i ny flik. Företagslänkar hoppar till FOI-rad.</div>
</header>

<main>
  <section id="tab-map" class="tab active">
    <div class="markmap" id="mm">
{_html.escape(combined_md)}
    </div>
  </section>

  <section id="tab-foi" class="tab">
    <div class="panel">
      <div class="controls">
        <input id="filter" type="search" placeholder="Sök i FOI-tabellen (bolag, säte, SNI, ägare, kommentar)…"/>
        <span class="meta" id="count"></span>
      </div>
      <div class="meta">FOI Tabell 2.1 (din lista). Ankare: c1–c128.</div>
      <div class="tablewrap">
        <table id="t">
          <thead><tr><th>Nr</th><th>Företag</th><th>Säte</th><th>SNI</th><th>Övrigt</th></tr></thead>
          <tbody>
            {table_rows}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.18.0"></script>
<script>
  const btnMap = document.getElementById('btn-map');
  const btnFoi = document.getElementById('btn-foi');
  const tabMap = document.getElementById('tab-map');
  const tabFoi = document.getElementById('tab-foi');

  function show(which){{
    if(which==='map') {{
      btnMap.classList.add('active'); btnFoi.classList.remove('active');
      tabMap.classList.add('active'); tabFoi.classList.remove('active');
      window.dispatchEvent(new Event('resize'));
    }} else {{
      btnFoi.classList.add('active'); btnMap.classList.remove('active');
      tabFoi.classList.add('active'); tabMap.classList.remove('active');
    }}
  }}
  btnMap.addEventListener('click', ()=>show('map'));
  btnFoi.addEventListener('click', ()=>show('foi'));

  // Link handling
  document.addEventListener('click', (e) => {{
    const a = e.target.closest && e.target.closest('a');
    if(!a) return;
    const href = a.getAttribute('href') || '';
    if(href.startsWith('http')) {{
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      return;
    }}
    if(href.startsWith('#c')) {{
      e.preventDefault();
      show('foi');
      const id = href.slice(1);
      const el = document.getElementById(id);
      if(el) {{
        history.replaceState(null,'',href);
        el.scrollIntoView({{block:'center'}});
      }}
    }}
  }}, true);

  // Search filter
  const input = document.getElementById('filter');
  const tbody = document.querySelector('#t tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const count = document.getElementById('count');

  function updateCount(){{
    const vis = rows.filter(r => r.style.display !== 'none').length;
    count.textContent = vis + ' / ' + rows.length;
  }}
  function applyFilter(q){{
    q = (q || '').trim().toLowerCase();
    for(const r of rows){{
      if(!q) {{ r.style.display=''; continue; }}
      r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
    }}
    updateCount();
  }}
  input.addEventListener('input', ()=>applyFilter(input.value));
  updateCount();
</script>
</body>
</html>
"""

out_path = Path("/mnt/data/mindmap_ALLT_basfil_plus_mosk_foi_register.html")
out_path.write_text(html_doc, encoding="utf-8")
str(out_path)
